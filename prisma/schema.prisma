// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------
// User & Auth (NuxtAuth / NextAuth Standard)
// --------------------------------------

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Settings for Coaching
  ftp           Int?      // Functional Threshold Power (Watts)
  maxHr         Int?      // Max Heart Rate
  weight        Float?    // Weight in kg (for W/kg calcs)
  dob           DateTime? // Date of birth for age-based metrics

  // Relations
  accounts      Account[]
  sessions      Session[]
  integrations  Integration[] // External App Connections (Whoop, Intervals)
  workouts      Workout[]
  dailyMetrics  DailyMetric[]
  wellness      Wellness[]
  reports       Report[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// --------------------------------------
// App Integrations (The "Senses")
// --------------------------------------

// Stores tokens for external fitness apps (Intervals.icu, Whoop, Strava)
// Distinct from 'Account' which is for Login/SSO
model Integration {
  id             String    @id @default(uuid())
  userId         String
  provider       String    // "intervals", "whoop", "strava", "garmin"
  
  // Auth Data
  accessToken    String
  refreshToken   String?
  expiresAt      DateTime?
  externalUserId String?   // The user's ID in the external system
  scope          String?   // What permissions we have

  // Sync Status
  lastSyncAt     DateTime?
  syncStatus     String?   // "SUCCESS", "FAILED", "SYNCING"
  errorMessage   String?

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
}

// --------------------------------------
// Normalized Fitness Data
// --------------------------------------

// A unified structure for workouts from any provider
model Workout {
  id              String   @id @default(uuid())
  userId          String
  externalId      String   // ID from the source (e.g., Strava Activity ID)
  source          String   // "intervals", "strava"
  
  // Core Data
  date            DateTime
  title           String
  description     String?  @db.Text
  type            String?  // "Ride", "Run", "WeightTraining"

  // Performance Metrics
  durationSec     Int
  distanceMeters  Float?
  elevationGain   Int?
  
  // Power & Heart Rate
  averageWatts    Int?
  maxWatts        Int?
  normalizedPower Int?
  weightedAvgWatts Int?
  averageHr       Int?
  maxHr           Int?
  averageCadence  Int?
  maxCadence      Int?
  averageSpeed    Float?
  
  // Training Load & Intensity
  tss             Float?   // Training Stress Score
  trainingLoad    Float?   // icu_training_load
  intensity       Float?   // Intensity Factor (0-1+ scale)
  kilojoules      Int?
  trimp           Int?
  
  // Performance Metrics
  ftp             Int?     // FTP at time of activity
  variabilityIndex Float?  // Power variability (NP/AP)
  powerHrRatio    Float?   // Power/HR efficiency
  efficiencyFactor Float?  // Power/HR at aerobic intensities
  decoupling      Float?   // Aerobic efficiency metric
  polarizationIndex Float? // Training distribution metric
  
  // Training Status (from Intervals.icu)
  ctl             Float?   // Chronic Training Load (Fitness)
  atl             Float?   // Acute Training Load (Fatigue)
  
  // Subjective Metrics
  rpe             Int?     // Rate of Perceived Exertion
  sessionRpe      Int?     // Session RPE
  feel            Int?     // How the workout felt (1-10)
  
  // Environmental & Equipment
  avgTemp         Float?   // Average temperature
  trainer         Boolean? // Indoor trainer workout
  
  // L/R Balance
  lrBalance       Float?   // Left/Right power balance
  
  // Raw Data storage (for re-analysis and accessing original data)
  rawJson         Json?    // Store the original full payload

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, date])
  @@unique([userId, source, externalId]) // Prevent duplicates
}

// Normalized Daily Health Data (Recovery, Sleep)
model DailyMetric {
  id             String   @id @default(uuid())
  userId         String
  date           DateTime @db.Date // YYYY-MM-DD
  source         String   // "whoop", "garmin", "oura"

  // Heart & Recovery
  hrv            Float?   // rMSSD (ms)
  restingHr      Int?
  
  // Sleep
  sleepScore     Int?     // 0-100
  hoursSlept     Float?
  
  // Proprietary Scores (Normalized)
  recoveryScore  Int?     // 0-100 (Whoop style)
  strainScore    Float?   // 0-21 (Whoop style) or similar
  
  spO2           Float?

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

// Wellness data from Intervals.icu (synced from various sources like Whoop, Garmin, etc.)
model Wellness {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime @db.Date // YYYY-MM-DD
  
  // Heart Rate Variability
  hrv               Float?   // Heart Rate Variability (ms)
  hrvSdnn           Float?   // HRV SDNN - autonomic nervous system balance
  
  // Heart Rate
  restingHr         Int?     // Resting heart rate
  avgSleepingHr     Int?     // Average sleeping heart rate
  
  // Sleep Metrics
  sleepSecs         Int?     // Total sleep in seconds
  sleepHours        Float?   // Computed: sleepSecs / 3600
  sleepScore        Int?     // Sleep quality score (0-100)
  sleepQuality      Int?     // Sleep quality rating (1-10)
  
  // Recovery & Readiness
  readiness         Int?     // Readiness to train (1-10)
  recoveryScore     Int?     // Recovery score (0-100)
  
  // Subjective Wellness Metrics
  soreness          Int?     // Muscle soreness (1-10)
  fatigue           Int?     // Fatigue level (1-10)
  stress            Int?     // Stress level (1-10)
  mood              Int?     // Mood rating (1-10)
  motivation        Int?     // Motivation level (1-10)
  
  // Physical Metrics
  weight            Float?   // Weight in kg
  spO2              Float?   // Blood oxygen saturation (%)
  
  // Training Load (from Intervals.icu)
  ctl               Float?   // Chronic Training Load (Fitness)
  atl               Float?   // Acute Training Load (Fatigue)
  
  // Notes
  comments          String?  @db.Text
  
  // Raw data for accessing original response
  rawJson           Json?
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

// --------------------------------------
// AI Agent Outputs
// --------------------------------------

model Report {
  id             String   @id @default(uuid())
  userId         String
  type           String   // "WEEKLY_ANALYSIS", "RACE_PREP", "DAILY_SUGGESTION"
  status         String   // "PENDING", "PROCESSING", "COMPLETED", "FAILED"
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Metadata
  dateRangeStart DateTime
  dateRangeEnd   DateTime
  modelVersion   String?  // e.g., "gemini-2.5-pro"
  
  // Content
  markdown       String?  @db.Text
  latex          String?  @db.Text // If we generated a formal document
  pdfUrl         String?  // URL to stored PDF in S3/Blob storage
  
  // Structured Suggestions (for the "Coach" agent)
  suggestions    Json?    // e.g., { "action": "rest", "reason": "HRV low" }

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
